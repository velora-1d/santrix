@extends('layouts.app')

@section('title', 'Data Nilai Santri')
@section('page-title', 'Data Nilai Santri')

@section('sidebar-menu')
    @include('pendidikan.partials.sidebar-menu')
@endsection

@section('content')
    @if(session('success'))
        <div class="alert alert-success" style="background-color: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #c3e6cb; font-size: 13px;">
            âœ“ {{ session('success') }}
        </div>
    @endif


    <!-- Compact Blue Gradient Header with Inline Filters -->
    <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 10px; padding: 16px 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(255,152,0,0.25);">
        <!-- Title Row -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                    <i data-feather="file-text" style="width: 20px; height: 20px; color: white;"></i>
                </div>
                <div>
                    <h2 style="font-size: 1.1rem; font-weight: 700; color: white; margin: 0 0 2px 0;">Rekapitulasi Nilai Ujian</h2>
                    <p style="color: rgba(255,255,255,0.85); font-size: 0.75rem; margin: 0;">Input dan kelola nilai ujian santri</p>
                </div>
            </div>
        </div>

        <!-- Compact Filter Form in Single Row -->
        <form method="GET" action="{{ route('pendidikan.nilai') }}" id="filterForm">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <!-- Kelas -->
                <div style="display: flex; flex-direction: column; gap: 4px; min-width: 180px;">
                    <label style="font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px; margin: 0; display: flex; align-items: center; gap: 4px;">
                        <i data-feather="users" style="width: 11px; height: 11px;"></i>
                        Kelas
                    </label>
                    <select name="kelas_id" id="kelas_id" required 
                        style="height: 38px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 0 12px; font-size: 13px; background: rgba(255,255,255,0.95); color: #1f2937; font-weight: 500; cursor: pointer;">
                        <option value="">-- Pilih Kelas --</option>
                        @foreach($kelasList as $kelas)
                            <option value="{{ $kelas->id }}" {{ request('kelas_id') == $kelas->id ? 'selected' : '' }}>
                                {{ $kelas->nama_kelas }}
                            </option>
                        @endforeach
                    </select>
                </div>
                
                <!-- Gender -->
                <div style="display: flex; flex-direction: column; gap: 4px; min-width: 130px;">
                    <label style="font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px; margin: 0; display: flex; align-items: center; gap: 4px;">
                        <i data-feather="user-check" style="width: 11px; height: 11px;"></i>
                        Gender
                    </label>
                    <select name="gender" id="gender" 
                        style="height: 38px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 0 12px; font-size: 13px; background: rgba(255,255,255,0.95); color: #1f2937; font-weight: 500; cursor: pointer;">
                        <option value="">Semua</option>
                        <option value="putra" {{ request('gender') == 'putra' ? 'selected' : '' }}>Putra</option>
                        <option value="putri" {{ request('gender') == 'putri' ? 'selected' : '' }}>Putri</option>
                    </select>
                </div>
                
                <!-- Tahun Ajaran -->
                <div style="display: flex; flex-direction: column; gap: 4px; min-width: 140px;">
                    <label style="font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px; margin: 0; display: flex; align-items: center; gap: 4px;">
                        <i data-feather="calendar" style="width: 11px; height: 11px;"></i>
                        Tahun Ajaran
                    </label>
                    <select name="tahun_ajaran" id="tahun_ajaran" required 
                        style="height: 38px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 0 12px; font-size: 13px; background: rgba(255,255,255,0.95); color: #1f2937; font-weight: 500; cursor: pointer;">
                        <!-- Remove placeholder hardcoded value, use loop and check against request or passed default -->
                        @foreach($tahunAjaranList as $ta)
                            <option value="{{ $ta }}" {{ request('tahun_ajaran', $tahunAjaran) == $ta ? 'selected' : '' }}>{{ $ta }}</option>
                        @endforeach
                    </select>
                </div>
                
                <!-- Semester -->
                <div style="display: flex; flex-direction: column; gap: 4px; min-width: 130px;">
                    <label style="font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.5px; margin: 0; display: flex; align-items: center; gap: 4px;">
                        <i data-feather="book-open" style="width: 11px; height: 11px;"></i>
                        Semester
                    </label>
                    <select name="semester" id="semester" required 
                        style="height: 38px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 0 12px; font-size: 13px; background: rgba(255,255,255,0.95); color: #1f2937; font-weight: 500; cursor: pointer;">
                        <option value="1" {{ request('semester', '1') == '1' ? 'selected' : '' }}>Ganjil</option>
                        <option value="2" {{ request('semester') == '2' ? 'selected' : '' }}>Genap</option>
                    </select>
                </div>
                
                <!-- Action Button -->
                <div style="display: flex; gap: 8px; margin-left: auto; align-self: flex-end;">
                    <button type="submit" id="loadDataBtn"
                        style="height: 38px; padding: 0 20px; display: inline-flex; align-items: center; gap: 6px; background: white; color: #ff9800; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.15);"
                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.15)';">
                        <i data-feather="eye" style="width: 14px; height: 14px;"></i>
                        <span id="btnText">Tampilkan Data</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" style="display: none; text-align: center; padding: 40px; background: white; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: inline-block; width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #ff9800; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 16px; color: #666; font-size: 14px;">Memuat data...</p>
    </div>

    <!-- Data Container -->
    <div id="dataContainer">

    @if(request('kelas_id'))
        @php
            $kelas = \App\Models\Kelas::find(request('kelas_id'));
            $tahunAjaran = request('tahun_ajaran', $tahunAjaran);
            $semester = request('semester', '1');
            
            // Get all santri in this class
            $santriQuery = \App\Models\Santri::where('kelas_id', request('kelas_id'));
            
            // Filter by gender if specified
            if (request('gender')) {
                $santriQuery->where('gender', request('gender'));
            }
            
            $santriList = $santriQuery->orderBy('nama_santri')->get();
            
            // Eager load nilai to pre-fill inputs
            $santriList = $santriQuery->with(['nilai' => function($q) use ($tahunAjaran, $semester) {
                $q->where('tahun_ajaran', $tahunAjaran)
                  ->where('semester', $semester);
            }])->orderBy('nama_santri')->get();
            
            // Use dynamic Mapel List passed from controller
            // If not available (e.g. direct view), fallback to empty
            $displayMapel = $mapelList ?? \App\Models\MataPelajaran::where('is_active', true)->get();
        @endphp

        <!-- Header -->
        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 16px; text-align: center; border-radius: 8px 8px 0 0; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
            <h3 style="margin: 0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                REKAPITULASI NILAI UJIAN KELAS {{ $kelas->nama_kelas }}
            </h3>
        </div>

        <div style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 10px; text-align: center;">
            <h4 style="margin: 0; font-size: 14px; font-weight: 600;">
                MATA PELAJARAN - SEMESTER {{ $semester == '1' ? 'GANJIL' : 'GENAP' }}
            </h4>
        </div>

        <!-- Table Form -->
        <form method="POST" action="{{ route('pendidikan.nilai.store-bulk') }}" id="nilaiForm">
            @csrf
            <input type="hidden" name="kelas_id" value="{{ request('kelas_id') }}">
            <input type="hidden" name="tahun_ajaran" value="{{ $tahunAjaran }}">
            <input type="hidden" name="semester" value="{{ $semester }}">
            
            <div style="background: white; border-radius: 0 0 8px 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%); color: white;">
                                <th style="padding: 12px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); min-width: 40px; position: sticky; left: 0; background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%); z-index: 10;">NO</th>
                                <th style="padding: 12px 8px; border: 1px solid rgba(255,255,255,0.2); min-width: 180px; position: sticky; left: 40px; background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%); z-index: 10;">NAMA SANTRI</th>
                                @foreach($displayMapel as $mapelIndex => $mapel)
                                    <th style="padding: 12px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); min-width: 70px; font-size: 11px; position: relative;" title="{{ $mapel->nama_mapel }}">
                                        {{ Str::limit($mapel->nama_mapel, 10) }}
                                    </th>
                                @endforeach
                                <th style="padding: 12px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,193,7,0.3); font-weight: 700;">JUMLAH</th>
                                <th style="padding: 12px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); background: rgba(76,175,80,0.3); font-weight: 700;">RATAÂ²</th>
                                <th style="padding: 12px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.2); background: rgba(244,67,54,0.3); font-weight: 700;">RANK</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach($santriList as $index => $santri)
                                <tr style="background-color: {{ $index % 2 == 0 ? '#fff9e6' : '#fffbf0' }}; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#fff3cd'" onmouseout="this.style.backgroundColor='{{ $index % 2 == 0 ? '#fff9e6' : '#fffbf0' }}'">
                                    <td style="padding: 10px 8px; text-align: center; border: 1px solid #e0e0e0; font-weight: 600; position: sticky; left: 0; background-color: {{ $index % 2 == 0 ? '#fff9e6' : '#fffbf0' }}; z-index: 5;">
                                        {{ $index + 1 }}
                                    </td>
                                    <td style="padding: 10px 8px; border: 1px solid #e0e0e0; position: sticky; left: 40px; background-color: {{ $index % 2 == 0 ? '#fff9e6' : '#fffbf0' }}; z-index: 5;">
                                        <input type="hidden" name="santri[{{ $index }}][id]" value="{{ $santri->id }}">
                                        <strong style="color: #2c3e50;">{{ $santri->nama_santri }}</strong>
                                    </td>
                                    @foreach($displayMapel as $mapelIndex => $mapel)
                                        @php
                                            $nilai = $santri->nilai->where('mapel_id', $mapel->id)->first();
                                            $isTalaran = $mapel->is_talaran;
                                            
                                            // For DISPLAY: show nilai_akhir if exists (calculated + compensated score)
                                            // For INPUT: user inputs raw exam score (nilai_uts)
                                            $displayValue = '';
                                            $inputValue = '';
                                            $tooltip = '';
                                            $isCompensated = false;
                                            $compensationType = '';
                                            $cellBgColor = '';
                                            $borderColor = '#e0e0e0';
                                            
                                            if ($nilai) {
                                                // If nilai exists, show the CALCULATED nilai_akhir (with compensation)
                                                $displayValue = $nilai->nilai_akhir;
                                                // But for editing, show raw exam score
                                                $inputValue = $nilai->nilai_uts;
                                                $isCompensated = $nilai->is_compensated;
                                                
                                                // Build tooltip
                                                if ($isTalaran) {
                                                    $nilaiUjian = $nilai->nilai_uts;
                                                    $rataTalaran = $nilai->nilai_tugas ?? 0;
                                                    $tooltip = "ðŸ“Š Ujian: {$nilaiUjian} | Talaran: {$rataTalaran}\nFormula: (30% Ã— {$rataTalaran}) + (70% Ã— {$nilaiUjian})";
                                                }
                                                
                                                // Check compensation status
                                                if ($isCompensated) {
                                                    $metadata = json_decode($nilai->compensation_metadata, true);
                                                    $compensationType = $metadata['type'] ?? '';
                                                    
                                                    if ($compensationType === 'recipient') {
                                                        // Received compensation (was below 5)
                                                        $cellBgColor = '#fff9c4'; // Light yellow
                                                        $borderColor = '#fbc02d'; // Yellow
                                                        $originalGrade = $metadata['original_grade'] ?? 0;
                                                        $received = $metadata['amount_received'] ?? 0;
                                                        $tooltip .= "\n\nðŸŸ¡ DIKOMPENSASI\nNilai Asli: {$originalGrade}\nKompensasi: +{$received}\nNilai Akhir: {$displayValue}";
                                                    } elseif ($compensationType === 'donor') {
                                                        // Donated to compensation
                                                        $cellBgColor = '#e3f2fd'; // Light blue
                                                        $borderColor = '#1976d2'; // Blue
                                                        $donated = $metadata['amount_donated'] ?? 0;
                                                        $tooltip .= "\n\nðŸ”µ MENDONOR\nDonasi: -{$donated}\nNilai Akhir: {$displayValue}";
                                                    }
                                                } elseif ($displayValue < 5) {
                                                    // Grade below 5 but not compensated (shouldn't happen after save)
                                                    $borderColor = '#f44336'; // Red
                                                    $tooltip .= "\n\nâš ï¸ Nilai di bawah 5";
                                                }
                                                
                                                // Override background for talaran
                                                if ($isTalaran && !$isCompensated) {
                                                    $cellBgColor = '#e8f5e9';
                                                }
                                            }
                                        @endphp
                                        <td style="padding: 6px; text-align: center; border: 1px solid #e0e0e0; {{ $cellBgColor ? 'background: ' . $cellBgColor . ';' : ($isTalaran ? 'background: #e8f5e9;' : '') }}" title="{{ $tooltip }}">
                                            @if($nilai && $isTalaran)
                                                {{-- Show calculated nilai_akhir as readonly display for talaran subjects --}}
                                                <div style="position: relative;">
                                                    <input type="number" 
                                                           name="santri[{{ $index }}][mapel][{{ $mapel->id }}]" 
                                                           class="nilai-input" 
                                                           data-row="{{ $index }}"
                                                           data-col="{{ $mapelIndex }}"
                                                           data-nilai-akhir="{{ $displayValue }}"
                                                           value="{{ $inputValue }}" 
                                                           min="0" 
                                                           max="100"
                                                           step="0.01"
                                                           placeholder="-"
                                                           style="width: 60px; padding: 6px; font-size: 13px; text-align: center; border: 2px solid {{ $borderColor }}; border-radius: 4px; background: {{ $cellBgColor ?: '#f1f8e9' }};">
                                                    @if($isCompensated && $compensationType === 'recipient')
                                                        <div style="position: absolute; top: -8px; right: -8px; background: #fbc02d; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;" title="Nilai dikompensasi (dinaikkan)">â†‘</div>
                                                    @elseif($isCompensated && $compensationType === 'donor')
                                                        <div style="position: absolute; top: -8px; right: -8px; background: #1976d2; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;" title="Nilai mendonor (diturunkan)">â†“</div>
                                                    @else
                                                        <div style="position: absolute; top: -8px; right: -8px; background: #4caf50; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;" title="Nilai dihitung otomatis: 30% Talaran + 70% Ujian">âœ“</div>
                                                    @endif
                                                    <small style="display: block; font-size: 9px; color: {{ $isCompensated ? ($compensationType === 'recipient' ? '#f57c00' : '#1565c0') : '#2e7d32' }}; margin-top: 2px; font-weight: 600;">{{ number_format($displayValue, 1) }}</small>
                                                </div>
                                            @else
                                                {{-- Regular input for non-talaran or new entries --}}
                                                <input type="number" 
                                                       name="santri[{{ $index }}][mapel][{{ $mapel->id }}]" 
                                                       class="nilai-input" 
                                                       data-row="{{ $index }}"
                                                       data-col="{{ $mapelIndex }}"
                                                       data-nilai-akhir="{{ $displayValue }}"
                                                       value="{{ $nilai ? $nilai->nilai_uts : '' }}" 
                                                       min="0" 
                                                       max="100"
                                                       step="0.01"
                                                       placeholder="-"
                                                       style="width: 60px; padding: 6px; font-size: 13px; text-align: center; border: 2px solid {{ $borderColor }}; border-radius: 4px; transition: all 0.2s; background: {{ $cellBgColor ?: ($isTalaran ? '#f1f8e9' : 'white') }};"
                                                       onfocus="this.style.borderColor='#43a047'; this.style.boxShadow='0 0 0 3px rgba(67,160,71,0.1)'"
                                                       onblur="this.style.borderColor='{{ $borderColor }}'; this.style.boxShadow='none'">
                                                @if($isTalaran && !$nilai)
                                                    <small style="display: block; font-size: 9px; color: #2e7d32; margin-top: 2px;">Auto</small>
                                                @endif
                                            @endif
                                        </td>
                                    @endforeach
                                    <td style="padding: 10px 8px; text-align: center; border: 1px solid #e0e0e0; background-color: #fff8e1;">
                                        <strong id="jumlah-{{ $index }}" style="font-size: 14px; color: #f57c00;">-</strong>
                                    </td>
                                    <td style="padding: 10px 8px; text-align: center; border: 1px solid #e0e0e0; background-color: #e8f5e9;">
                                        <strong id="rata-{{ $index }}" style="font-size: 14px; color: #2e7d32;">-</strong>
                                    </td>
                                    <td style="padding: 10px 8px; text-align: center; border: 1px solid #e0e0e0; background-color: #ffebee;">
                                        <span id="rank-{{ $index }}" style="font-size: 13px; font-weight: 600; color: #c62828;">-</span>
                                    </td>
                                </tr>
                            @endforeach
                            
                            <!-- Summary Row: Jumlah Total -->
                            <tr style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); font-weight: 700;">
                                <td colspan="2" style="padding: 12px 8px; text-align: center; border: 1px solid #90caf9; color: #1565c0; font-size: 13px;">
                                    ðŸ“Š JUMLAH
                                </td>
                                @foreach($displayMapel as $mapelIndex => $mapel)
                                    <td id="sum-{{ $mapelIndex }}" style="padding: 12px 8px; text-align: center; border: 1px solid #90caf9; font-size: 12px; color: #1976d2;">
                                        -
                                    </td>
                                @endforeach
                                <td colspan="3" id="grand-total" style="padding: 12px 8px; text-align: center; border: 1px solid #90caf9; font-size: 14px; color: #0d47a1;">
                                    -
                                </td>
                            </tr>
                            
                            <!-- Summary Row: Rata-rata per Pelajaran -->
                            <tr style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); font-weight: 700;">
                                <td colspan="2" style="padding: 12px 8px; text-align: center; border: 1px solid #ffb74d; color: #e65100; font-size: 13px;">
                                    ðŸ“ˆ RATA-RATA
                                </td>
                                @foreach($displayMapel as $mapelIndex => $mapel)
                                    <td id="avg-{{ $mapelIndex }}" style="padding: 12px 8px; text-align: center; border: 1px solid #ffb74d; font-size: 12px; color: #f57c00;">
                                        -
                                    </td>
                                @endforeach
                                <td colspan="3" id="grand-avg" style="padding: 12px 8px; text-align: center; border: 1px solid #ffb74d; font-size: 14px; color: #e65100;">
                                    -
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="padding: 20px; background: #f8f9fa; border-top: 2px solid #e0e0e0;">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary" style="padding: 10px 24px; font-size: 14px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); border: none; border-radius: 6px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(33,150,243,0.3);">
                            <i data-feather="save" style="width: 16px; height: 16px;"></i>
                            Simpan Semua Nilai
                        </button>
                        <button type="button" onclick="calculateRanking()" class="btn btn-secondary" style="padding: 10px 24px; font-size: 14px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none; border-radius: 6px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(255,152,0,0.3);">
                            <i data-feather="award" style="width: 16px; height: 16px;"></i>
                            Hitung Ranking
                        </button>
                        <a href="{{ route('pendidikan.nilai.cetak', [
                            'kelas_id' => request('kelas_id'),
                            'tahun_ajaran' => $tahunAjaran,
                            'semester' => $semester,
                            'gender' => request('gender')
                        ]) }}" 
                           target="_blank"
                           class="btn btn-secondary" 
                           style="padding: 10px 24px; font-size: 14px; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); border: none; border-radius: 6px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(76,175,80,0.3); text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                            <i data-feather="printer" style="width: 16px; height: 16px;"></i>
                            Cetak PDF
                        </a>
                        <button type="button" onclick="clearAll()" class="btn btn-secondary" style="padding: 10px 24px; font-size: 14px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); border: none; border-radius: 6px; color: white; font-weight: 600;">
                            <i data-feather="x-circle" style="width: 16px; height: 16px;"></i>
                            Reset Semua
                        </button>
                    </div>
                </div>
            </div>
        </form>
    @else
        <div style="background: white; border-radius: 8px; padding: 60px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <i data-feather="info" style="width: 80px; height: 80px; color: #bbb; margin-bottom: 20px;"></i>
            <p style="color: #777; font-size: 16px; margin: 0;">Silakan pilih kelas, tahun ajaran, dan semester untuk menampilkan data nilai</p>
        </div>
    @endif
    </div> <!-- End dataContainer -->
@endsection

@push('scripts')
<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// AJAX Form Submission
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const dataContainer = document.getElementById('dataContainer');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const btnText = document.getElementById('btnText');
    
    // Handle form submission
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent page reload
            
            // Get form data
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData).toString();
            
            // Show loading
            loadingIndicator.style.display = 'block';
            dataContainer.style.display = 'none';
            loadDataBtn.disabled = true;
            btnText.textContent = 'Memuat...';
            
            // Fetch data via AJAX
            fetch(`{{ route('pendidikan.nilai') }}?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the HTML response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.getElementById('dataContainer');
                
                if (newContent) {
                    dataContainer.innerHTML = newContent.innerHTML;
                } else {
                    dataContainer.innerHTML = html;
                }
                
                // Hide loading, show data
                loadingIndicator.style.display = 'none';
                dataContainer.style.display = 'block';
                loadDataBtn.disabled = false;
                btnText.textContent = 'Tampilkan Data';
                
                // Re-initialize feather icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
                // Re-attach event listeners for nilai inputs
                initializeNilaiInputs();
                
                // Trigger calculations to restore JUMLAH, RATA, and RANK after AJAX load
                setTimeout(() => {
                    const rows = document.querySelectorAll('#nilaiForm tbody tr:not(:nth-last-child(-n+2))');
                    rows.forEach((row, index) => {
                        calculateRowTotal(index);
                    });
                    calculateColumnStats();
                    calculateRanking(true); // silent ranking
                }, 100);
                
                // Update URL without reload
                window.history.pushState({}, '', `{{ route('pendidikan.nilai') }}?${params}`);
            })
            .catch(error => {
                console.error('Error:', error);
                loadingIndicator.style.display = 'none';
                dataContainer.style.display = 'block';
                loadDataBtn.disabled = false;
                btnText.textContent = 'Tampilkan Data';
                alert('Terjadi kesalahan saat memuat data. Silakan coba lagi.');
            });
        });
    }
    
    // Initialize nilai inputs
    initializeNilaiInputs();
    
    // Replace feather icons after DOM load
    setTimeout(() => feather.replace(), 100);
});

function initializeNilaiInputs() {
    const nilaiInputs = document.querySelectorAll('.nilai-input');
    
    nilaiInputs.forEach(input => {
        input.addEventListener('input', function() {
            const row = this.dataset.row;
            calculateRowTotal(row);
            calculateColumnStats();
            calculateRanking(true); // Auto-calculate ranking on every input (silent mode)
        });
    });

    // Trigger calculations on load for existing data
    const rows = document.querySelectorAll('#nilaiForm tbody tr:not(:nth-last-child(-n+2))');
    rows.forEach((row, index) => {
        calculateRowTotal(index);
    });
    calculateColumnStats();
    calculateRanking(true); // silent ranking
}

function calculateRowTotal(row) {
    const inputs = document.querySelectorAll(`input[data-row="${row}"]`);
    let total = 0;
    let count = 0;
    
    inputs.forEach(input => {
        // Use nilai_akhir (compensated grade) if available, otherwise use input value
        const nilaiAkhir = input.dataset.nilaiAkhir;
        const value = nilaiAkhir && nilaiAkhir !== '' ? parseFloat(nilaiAkhir) : parseFloat(input.value);
        
        if (!isNaN(value)) {
            total += value;
            count++;
        }
    });
    
    const jumlahEl = document.getElementById(`jumlah-${row}`);
    const rataEl = document.getElementById(`rata-${row}`);
    
    if (jumlahEl) jumlahEl.textContent = count > 0 ? total.toFixed(1) : '-';
    if (rataEl) rataEl.textContent = count > 0 ? (total / count).toFixed(1) : '-';
}

function calculateColumnStats() {
    const sampleRow = document.querySelector('#nilaiForm tbody tr');
    if (!sampleRow) return;

    const mapelCount = sampleRow.querySelectorAll('.nilai-input').length;
    let grandTotal = 0;
    let grandCount = 0;
    
    for (let i = 0; i < mapelCount; i++) {
        const inputs = document.querySelectorAll(`input[data-col="${i}"]`);
        let sum = 0;
        let count = 0;
        
        inputs.forEach(input => {
            // Use nilai_akhir (compensated grade) if available, otherwise use input value
            const nilaiAkhir = input.dataset.nilaiAkhir;
            const value = nilaiAkhir && nilaiAkhir !== '' ? parseFloat(nilaiAkhir) : parseFloat(input.value);
            
            if (!isNaN(value)) {
                sum += value;
                count++;
                grandTotal += value;
                grandCount++;
            }
        });
        
        const sumEl = document.getElementById(`sum-${i}`);
        const avgEl = document.getElementById(`avg-${i}`);
        if(sumEl) sumEl.textContent = count > 0 ? sum.toFixed(1) : '-';
        if(avgEl) avgEl.textContent = count > 0 ? (sum / count).toFixed(1) : '-';
    }
    
    const gtEl = document.getElementById('grand-total');
    const gaEl = document.getElementById('grand-avg');
    if(gtEl) gtEl.textContent = grandCount > 0 ? grandTotal.toFixed(2) : '-';
    if(gaEl) gaEl.textContent = grandCount > 0 ? (grandTotal / grandCount).toFixed(2) : '-';
}

function calculateRanking(silent = false) {
    const rows = document.querySelectorAll('tbody tr:not(:nth-last-child(-n+2))'); // Exclude last 2 summary rows
    const scores = [];
    
    rows.forEach((row, index) => {
        const rataText = document.getElementById(`rata-${index}`).textContent;
        const rata = parseFloat(rataText);
        if (!isNaN(rata)) {
            scores.push({ index, rata });
        }
    });
    
    // Sort by rata descending
    scores.sort((a, b) => b.rata - a.rata);
    
    // Assign ranks
    scores.forEach((item, rank) => {
        const rankEl = document.getElementById(`rank-${item.index}`);
        if (!isNaN(item.rata)) {
            rankEl.textContent = rank + 1;
            if (rank === 0) rankEl.innerHTML = 'ðŸ¥‡ 1';
            else if (rank === 1) rankEl.innerHTML = 'ðŸ¥ˆ 2';
            else if (rank === 2) rankEl.innerHTML = 'ðŸ¥‰ 3';
        } else {
            rankEl.textContent = '-';
        }
    });
    
    if (!silent) alert('âœ… Ranking berhasil dihitung!');
}

function clearAll() {
    if (confirm('Yakin ingin menghapus semua input nilai?')) {
        document.querySelectorAll('.nilai-input').forEach(input => input.value = '');
        document.querySelectorAll('[id^="jumlah-"]').forEach(el => el.textContent = '-');
        document.querySelectorAll('[id^="rata-"]').forEach(el => el.textContent = '-');
        document.querySelectorAll('[id^="rank-"]').forEach(el => el.textContent = '-');
        document.querySelectorAll('[id^="sum-"]').forEach(el => el.textContent = '-');
        document.querySelectorAll('[id^="avg-"]').forEach(el => el.textContent = '-');
        document.getElementById('grand-total').textContent = '-';
        document.getElementById('grand-avg').textContent = '-';
    }
}

// Edit Mapel Name Functions
function editMapelName(index) {
    document.getElementById(`mapel-view-${index}`).style.display = 'none';
    const input = document.getElementById(`mapel-edit-${index}`);
    input.style.display = 'block';
    input.focus();
    input.select();
}

function saveMapelName(index) {
    const input = document.getElementById(`mapel-edit-${index}`);
    const newName = input.value.trim() || 'Mata Pelajaran';
    
    document.getElementById(`mapel-text-${index}`).textContent = newName;
    document.getElementById(`mapel-view-${index}`).style.display = 'block';
    input.style.display = 'none';
    
    // Re-render feather icons
    feather.replace();
}
</script>
@endpush
